# Next-Phase Backlog (Execution Ready)

Primary roadmap: `docs/rendering-roadmap-2026.md`

## Targeted Phase Lanes (Current)
- Phase A (active): visual quality/post stack maturation.
- Phase B (active polish): lighting + shadow parity/refinement.
- Phase C (active): Vulkan hardening/scalability and real-device validation expansion.
- Phase D (planned): platform/tooling expansion.

## Latest Completed Batch (February 2026)
- Phase A SSAO controls expansion landed:
  - `PostProcessDesc` now supports `ssaoRadius`, `ssaoBias`, and `ssaoPower` with backward-compatible constructors.
  - OpenGL and Vulkan now apply SSAO shaping controls in both scene shader and dedicated post-pass paths.
  - Compare harness includes new deterministic `post-process-ssao-stress` profile with tiered and stress-golden bounds.
- Phase A kickoff landed:
  - upgraded SSAO-lite kernel shaping in OpenGL and Vulkan shader paths (multi-sample edge weighting + curvature/micro-contrast response)
  - kept API/runtime interfaces stable while improving post-pass SSAO visual stability
- Tightened parity stress thresholds:
  - `shadow-cascade-stress` `0.35 -> 0.34 -> 0.33 -> 0.32 -> 0.31 -> 0.30 -> 0.29 -> 0.28 -> 0.27 -> 0.26 -> 0.25`
  - `fog-shadow-cascade-stress` `0.40 -> 0.39 -> 0.38 -> 0.37 -> 0.36 -> 0.35 -> 0.34 -> 0.33 -> 0.32 -> 0.31 -> 0.30 -> 0.29 -> 0.28 -> 0.27 -> 0.26 -> 0.25`
  - `smoke-shadow-cascade-stress` `0.40 -> 0.39 -> 0.38 -> 0.37 -> 0.36 -> 0.35 -> 0.34 -> 0.33 -> 0.32 -> 0.31 -> 0.30 -> 0.29 -> 0.28 -> 0.27 -> 0.26 -> 0.25`
  - `fog-smoke-shadow-post-stress` `0.37 -> 0.35 -> 0.34 -> 0.33 -> 0.32 -> 0.31 -> 0.30 -> 0.29 -> 0.28 -> 0.27 -> 0.26 -> 0.25 -> 0.24 -> 0.23 -> 0.22 -> 0.21 -> 0.20 -> 0.19 -> 0.18 -> 0.17 -> 0.16 -> 0.15 -> 0.14 -> 0.13 -> 0.12 -> 0.11 -> 0.10 -> 0.09 -> 0.08 -> 0.07 -> 0.06 -> 0.05`
  - `post-process-bloom (HIGH)` `0.36 -> 0.35 -> 0.34 -> 0.33 -> 0.32 -> 0.31 -> 0.30 -> 0.29 -> 0.28 -> 0.27 -> 0.26 -> 0.25 -> 0.24 -> 0.23 -> 0.22 -> 0.21 -> 0.20 -> 0.19 -> 0.18 -> 0.17 -> 0.16 -> 0.15 -> 0.14 -> 0.13 -> 0.12 -> 0.11 -> 0.10 -> 0.09 -> 0.08 -> 0.07 -> 0.06`
  - practical floor detected at attempted `fog-smoke-shadow-post-stress=0.04` (`diff=0.04049019607843137`); envelopes frozen at `0.05` / `0.06`.
- Added tiered `texture-heavy` parity envelopes (`LOW/MEDIUM/HIGH/ULTRA`) in compare-harness tests.
- Expanded Vulkan dynamic-scene reuse path with texture-only rebind support:
  - geometry/buffer-stable scene edits that change only material texture bindings now avoid full mesh-buffer rebuilds
  - texture descriptors are refreshed in-place and scene reuse telemetry now reports `textureRebindHits`
  - guarded Vulkan integration test added to assert texture-only updates keep `meshBufferRebuilds` stable
- Expanded native KTX decode coverage:
  - added 16-bit uncompressed KTX2 format family support (`R16_UNORM`, `R16G16_UNORM`, `R16G16B16A16_UNORM`) with 16-bit -> 8-bit normalization for baseline ingestion
  - added decoder tests for `R16`/`RG16` KTX2 payloads
- Backend KTX ingestion now prefers native container decode first and only falls back to sidecar assets when decode is unavailable.
- Added KTX2 Zstd supercompression decode path (scheme `2`) for baseline decodable format families.
- OpenGL smoke parity tightened by replacing hardcoded `1920x1080` shader scaling with runtime viewport-sized smoke radial scaling.
- Vulkan smoke parity tightened to runtime swapchain viewport scaling (removes fixed-size radial assumption).
- BRDF tier-extreme consistency polish applied in both backends:
  - added roughness-edge attenuation on diffuse/specular IBL contribution at very glossy/very rough extremes.
- Expanded Vulkan dynamic staging guardrails:
  - configurable upload-range soft limit warning path (`vulkan.pendingUploadRangeSoftLimit`, `vulkan.pendingUploadRangeWarnCooldownFrames`)
  - runtime warning: `PENDING_UPLOAD_RANGE_SOFT_LIMIT_EXCEEDED`
  - frame-resource profile now includes pending-range soft-limit config and cooldown counters.
- Expanded parity harness with deterministic `brdf-tier-extremes` profile and tiered + stress-golden bounds.
  - tightened ULTRA envelope `0.31 -> 0.30` after BRDF/staging parity pass remained green.
  - tightened ULTRA envelope `0.30 -> 0.29` after BasisLZ/UASTC transcoding rollout remained green.
- Expanded KTX2 transcode-gap classification for BasisLZ/UASTC families:
  - KTX2 supercompression scheme `1` is now treated as BasisLZ (transcode-required), not zlib.
  - decode-unavailable and variant-unsupported counters now exclude transcode-required KTX2 paths.
  - new runtime warning emitted in both backends: `IBL_KTX_TRANSCODE_REQUIRED`.
  - zlib KTX2 decode path now aligns to scheme `3`; zstd remains scheme `2`.
- Implemented true BasisLZ/UASTC decode/upload path:
  - `engine-impl-common` now includes `lwjgl-ktx` and native `libktx` runtime artifacts.
  - KTX2 BasisLZ/UASTC payloads are transcoded in-memory via `ktxTexture2_TranscodeBasis(..., KTX_TTF_RGBA32, ...)`.
  - decoded RGBA output is consumed directly by OpenGL/Vulkan texture ingestion (no PNG sidecar requirement).
  - backend lifecycle tests validate that real BasisLZ KTX2 channels no longer emit `IBL_KTX_TRANSCODE_REQUIRED` when transcoding succeeds.
- Expanded guarded real-device matrix coverage:
  - new long-endurance Vulkan integration test path gated by `-Ddle.test.vulkan.real.long=true`
  - CI matrix now includes dedicated guarded long-endurance Vulkan job on macOS/Linux/Windows.
- Added deterministic `material-fog-smoke-shadow-cascade-stress` compare profile:
  - combines textured materials with fog + smoke + cascaded shadows
  - includes tiered envelope assertions (`LOW/MEDIUM/HIGH/ULTRA`)
  - includes ULTRA stress-golden envelope assertion
- Closed an OpenGL/Vulkan IBL parity gap by applying AO modulation to OpenGL IBL diffuse ambient (matching Vulkan behavior).
- Implemented Phase 2 Item 1 baseline hook:
  - environment-driven IBL baseline in OpenGL and Vulkan
  - shader-side IBL texture sampling baseline in OpenGL and Vulkan (irradiance/radiance/BRDF-LUT)
  - roughness-aware radiance prefilter approximation in OpenGL and Vulkan (tier-driven prefilter strength)
  - roughness-aware multi-tap specular radiance filtering in OpenGL and Vulkan (`IBL_MULTI_TAP_SPEC_ACTIVE`)
  - BRDF energy-compensation + horizon-weighted IBL response in OpenGL and Vulkan (`IBL_BRDF_ENERGY_COMP_ACTIVE`)
  - view-space camera-direction IBL response in both backends (replaces fixed forward-view assumption)
  - texture ingestion + calibration support for configured IBL assets (`png/jpg/jpeg/.hdr`)
  - `.ktx/.ktx2` IBL container paths now resolve through sidecar decode sources when available (`.png/.hdr/.jpg/.jpeg`)
  - explicit `IBL_KTX_CONTAINER_FALLBACK` and `IBL_PREFILTER_APPROX_ACTIVE` warnings emitted for IBL runtime mode visibility
  - explicit missing-asset fallback runtime signal added: `IBL_ASSET_FALLBACK_ACTIVE` (configured IBL assets missing/unreadable)
  - skybox-derived IBL fallback path enabled when explicit irradiance/radiance maps are absent (`EnvironmentDesc.skyboxAssetPath`)
  - explicit skybox-derived mode runtime signal added: `IBL_SKYBOX_DERIVED_ACTIVE`
  - KTX irradiance/radiance recovery path added: unresolved `.ktx/.ktx2` channels can fallback to skybox-derived inputs (`IBL_KTX_SKYBOX_FALLBACK_ACTIVE`)
  - explicit decode-gap warning added when KTX container files exist without active native decode path: `IBL_KTX_DECODE_UNAVAILABLE`
  - bridge mapping preserves `EnvironmentDesc` IBL fields and `PostProcessDesc`
  - new backend tests assert `IBL_BASELINE_ACTIVE` and `IBL_ASSET_FALLBACK_ACTIVE` signals
  - IBL quality-tier policy tightened in OpenGL + Vulkan:
    - stronger LOW/MEDIUM tier attenuation for diffuse/specular/prefilter strengths
    - explicit runtime warning when tier-driven IBL degradation is active: `IBL_QUALITY_DEGRADED`
    - backend tests now assert `IBL_QUALITY_DEGRADED` on LOW and no degradation warning on ULTRA
- Phase 2 Item 2 baseline started:
  - API light-type expansion added (`LightType`: `DIRECTIONAL`, `POINT`, `SPOT`) with backward-compatible `LightDesc` constructors.
  - OpenGL/Vulkan lighting selection now prefers typed directional + point/spot lights instead of pure list-position assumptions.
  - Spot lights now use cone-attenuated shading (direction + inner/outer cone) in OpenGL and Vulkan.
  - OpenGL shadow-map execution now supports directional + spot + point lights (point via cubemap depth sampling baseline).
  - Vulkan point-light shadows now run through a 6-face layered path aligned to cubemap directions (+X/-X/+Y/-Y/+Z/-Z).
  - Adaptive point-shadow PCF/bias scaling now applied in both backends to improve near/far stability.
  - Backend tests ensure legacy `SPOT_LIGHT_APPROX_ACTIVE` warning remains absent and verify point/spot shadow warning behavior.
- Hardened Vulkan frame-resource architecture:
  - configurable ring sizing (`vulkan.framesInFlight`, default `3`, clamp `2..6`)
  - configurable dynamic-scene uniform capacity (`vulkan.maxDynamicSceneObjects`, default `2048`)
  - configurable pending upload-range capacity (`vulkan.maxPendingUploadRanges`, default `64`, clamp `8..2048`)
  - configurable dirty-range merge gap for dynamic uploads (`vulkan.dynamicUploadMergeGapObjects`, default `1`, clamp `0..32`)
  - per-frame descriptor-set ring for global uniforms
  - persistent mapped staging for frame-uniform uploads
  - pending upload-range tracking now auto-grows up to a hard cap before overflow fallback
  - expanded frame-resource telemetry fields
  - revision-aware dynamic uniform staging:
    - per-frame revision tracking for global + scene uniform state
    - skip uniform buffer copy when frame slot is already synchronized
    - sparse multi-range uniform uploads for dynamic-only scene updates using dirty object ranges
    - global-state setters now mark revisions only on effective value changes (reduces redundant uploads under stable scene settings)
    - additional telemetry: upload ranges + start-object index + pending-range overflow count
  - descriptor-ring pressure telemetry now exposed in frame profile:
    - `descriptorRingSetCapacity` / `descriptorRingPeakSetCapacity`
    - `descriptorRingActiveSetCount` / `descriptorRingWasteSetCount` / `descriptorRingPeakWasteSetCount`
    - `descriptorRingMaxSetCapacity` / `descriptorRingCapBypasses`
    - `descriptorRingReuseHits`
    - `descriptorRingGrowthRebuilds` / `descriptorRingSteadyRebuilds`
    - descriptor-pool reset/reuse path active when descriptor capacity is sufficient
    - `descriptorRingPoolReuses` / `descriptorRingPoolResetFailures`
    - ring growth now uses capacity targeting (growth + power-of-two rounding) with configurable soft cap (`vulkan.maxTextureDescriptorSets`)
    - sustained high-waste warning added: `DESCRIPTOR_RING_WASTE_HIGH` with configurable ratio/frame/capacity thresholds
    - cap-pressure warning added: `DESCRIPTOR_RING_CAP_PRESSURE` with configurable bypass/frame thresholds
    - warning cooldowns added for both `DESCRIPTOR_RING_WASTE_HIGH` and `DESCRIPTOR_RING_CAP_PRESSURE` to limit repeated-frame log spam
    - frame profile now includes live cooldown counters (`descriptorRingWasteWarnCooldownRemaining`, `descriptorRingCapPressureWarnCooldownRemaining`)
- Added Vulkan mesh-geometry cache in asset loader:
  - glTF/fallback geometry is cached by stable key
  - loader returns defensive copies to preserve cache integrity
  - reduces repeated parse/geometry-construction churn across scene reloads
  - runtime now exposes cache behavior via `MESH_GEOMETRY_CACHE_PROFILE` warning (`hits/misses/evictions/entries/maxEntries`)
  - cache capacity is configurable via `vulkan.meshGeometryCacheEntries` (default `256`)
- Expanded guarded real-Vulkan suite:
  - longer resize/scene-switch endurance loop
  - forced device-loss error-path test
  - native-runtime readiness guard to skip cleanly when LWJGL natives are unavailable
  - added targeted reuse assertions for lighting-only and post/fog-only scene updates (no full rebuilds or descriptor pool rebuilds on real-device path)
  - added guarded validation for descriptor-ring reuse counters on dynamic-only scene updates

## Active Next Steps
- Phase A immediate:
  - upgrade SSAO-lite quality path (stronger kernel shaping; tier-aware behavior)
  - rerun guarded compare set and retighten post-process envelopes where stable
- Phase B immediate:
  - run another OpenGL/Vulkan parity tuning cycle after Phase A shader changes settle
- Phase C immediate:
  - deepen staged/ring updates for additional scene data classes and extend per-frame ownership guardrails
  - extend guarded long-endurance and forced-error matrix coverage
- Threshold tightening lane is complete for current stress profiles; revisit only after material visual changes.
- Expand deterministic golden scenes for additional fog/smoke/shadow/material interactions.
- Phase 2 IBL maturity lane is now functionally complete:
  - native `.ktx/.ktx2` decode/transcode path is active for baseline uncompressed + zlib + zstd + BasisLZ/UASTC families
  - 16-bit uncompressed family support includes `R16/RG16/RGB16/RGBA16` normalization
  - fallback decode path now attempts `libktx` decode/transcode when baseline header-path decoding is unavailable
  - tier-extreme BRDF parity pass applied consistently in OpenGL and Vulkan shaders
  - remaining in this lane is parity tuning/regression observation only (not core missing functionality)
- Optional Phase 2 SSAO/HBAO-lite item is now closed as SSAO-lite baseline:
  - implemented in both OpenGL and Vulkan paths with tier-aware attenuation policy
  - compare harness now includes `post-process-ssao` profile and bounded threshold checks
- Ongoing parity tuning lane:
  - tightened `post-process` HIGH bound from `0.33 -> 0.32`
  - continue incremental tightening after additional deterministic scene expansion
- Shadow fidelity tune: radius/cascade-aware depth-bias scaling now applied in both backends to reduce acne/flicker at higher PCF/cascade settings.
- Extend Vulkan dynamic-update staging strategy to more scene data beyond current global/object uniform split:
  - material/instance-class staging paths
  - broader descriptor update batching under heavy scene churn
- Dynamic scene ownership guardrails expanded:
  - configurable soft-limit telemetry (`vulkan.dynamicObjectSoftLimit`)
  - frame profile now reports observed dynamic-object peak and emits `DYNAMIC_SCENE_SOFT_LIMIT_EXCEEDED` when exceeded
- Added Vulkan pressure guardrails for runtime stability at larger scene scale:
  - `UNIFORM_UPLOAD_SOFT_LIMIT_EXCEEDED` warning with configurable upload-byte soft limit + cooldown
  - `DESCRIPTOR_RING_ACTIVE_SOFT_LIMIT_EXCEEDED` warning with configurable active-set soft limit + cooldown
- Vulkan dynamic staging/resource-ring strategy expanded:
  - split frame-uniform path into `GlobalData` (per-frame non-dynamic UBO) + `ObjectData` (dynamic per-mesh UBO)
  - global-only scene changes now upload only global scene bytes (no full per-object rewrite)
  - frame-resource telemetry now reports global upload bytes separately from object upload bytes
  - uniform upload soft-limit warning now evaluates total global+object bytes per frame
- Add more real-device validation coverage across multiple machine/driver profiles.
  - CI now invokes guarded real-device Vulkan integration suite on macOS/Linux/Windows runners.

## P0-1 Vulkan Albedo Texturing Vertical Slice
- Scope: Implement end-to-end albedo texture sampling in Vulkan for glTF meshes.
- Tasks:
  - Add Vulkan image upload path (`staging -> device-local image -> sampled layout`).
  - Add sampler/image descriptor set layout and per-mesh descriptor binding.
  - Sample `baseColorTexture` in Vulkan fragment shader using mesh UVs.
  - Keep material factor fallback when texture is missing.
- Definition of Done:
  - Vulkan renders textured output for a scene with `MaterialDesc.albedoTexturePath`.
  - No Vulkan validation errors on texture upload/binding.
  - Existing Vulkan integration tests still pass.

## P0-2 Backend Comparison Harness
- Status: Implemented (including guarded CI mode).
- Scope: Make parity measurable.
- Tasks:
  - Extend sample host with `--compare` mode.
  - Render the same scene with OpenGL and Vulkan and write PNG outputs.
  - Compute a simple diff metric and fail if above threshold.
- Definition of Done:
  - One command produces paired captures and a numeric diff.
  - CI can run comparison in a guarded mode.

## P1-1 Vulkan Normal Mapping
- Status: Implemented.
- Scope: Add normal-map support after albedo path is stable.
- Tasks:
  - Add normal texture descriptor binding and tangent-space normal sampling.
  - Reuse glTF tangents if present; fallback to geometric normal.
- Definition of Done:
  - Normal-mapped model looks materially different from albedo-only shading.

## P1-2 Material Workflow Polish (Both Backends)
- Status: Implemented (baseline).
- Scope: Improve metallic-roughness parity and fallbacks.
- Tasks:
  - Parse/use metallic-roughness texture channel data where present.
  - Keep stable defaults for missing maps.
- Definition of Done:
  - Same scene has close visual intent across OpenGL and Vulkan.
